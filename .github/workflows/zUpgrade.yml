
# ATTRIBUTION-AI: Some code here may have been generated by Github Copilot Chat, ChatGPT, or other LLM, etc. Usually, there will be a comment acknowledging this in files this file was derived from, or in previous versions of this file. Moreover, it is reasonable simply to state AI may have partially written some code in this file, and that any AI generated code is minimal, obvious, could not have been written any other way, deals solely with GitHub APIs, etc...
# Comments, unused code, etc, have unusually been kept minimal in this file, to distract less from understaning the flow of jobs, which is already somewhat more difficult to see plainly in YML scripting.

# WARNING: May be untested .

name: zUpgrade

# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
permissions:
  actions: write
  checks: read
  contents: write
  deployments: read
  issues: none
  packages: read
  pull-requests: read
  repository-projects: read
  security-events: none
  statuses: read


on:
  #push:
  workflow_dispatch:
    inputs:
      devfast:
        type: boolean
        default: true
      skimfast:
        type: boolean
        default: true
      releaseLabel:
        required: false
        default: spring
        #default: internal
        type: choice
        options:
        - latest
        - spring
        - internal
        - base
      #DISABLE_RELEASE:
        #type: boolean
        #default: false
  # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule
  #schedule:
    #- cron: ''

# https://docs.github.com/en/actions/using-jobs/using-concurrency
concurrency:
  #group: ${{ github.workflow }}-${{ github.ref }}
  group: build-${{ github.ref }}
  cancel-in-progress: true


jobs:
  build_ubcp:
    runs-on: ubuntu-latest
    #runs-on: 'ubuntu-22.04'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          submodules: 'recursive'
      - name: mkdir _local
        shell: bash
        run: |
          mkdir -p ./_local
      - name: _getMinimal_cloud-special
        shell: bash
        timeout-minutes: 120
        run: |
          sudo -n apt-get -y install jq gh curl coreutils p7zip findutils tar gzip bzip2 sed axel aria2 rsync pv dos2unix xxd util-linux openssl
          ./ubiquitous_bash.sh _here_opensslConfig_legacy | sudo -n tee /etc/ssl/openssl_legacy.cnf > /dev/null 2>&1
          if ! sudo -n grep 'openssl_legacy' /etc/ssl/openssl.cnf > /dev/null 2>&1
          then
              sudo -n cp -f /etc/ssl/openssl.cnf /etc/ssl/openssl.cnf.orig
              echo '


              .include = /etc/ssl/openssl_legacy.cnf

              ' | sudo -n cat /etc/ssl/openssl.cnf.orig - | sudo -n tee /etc/ssl/openssl.cnf > /dev/null 2>&1
          fi
          true
      
      - name: _test_hash_legacy
        shell: bash
        run: |
          if [[ -e "/etc/ssl/openssl_legacy.cnf" ]]
          then
              echo -n | env OPENSSL_CONF="/etc/ssl/openssl_legacy.cnf" openssl dgst -whirlpool -binary | xxd -p -c 256
              exit ${PIPESTATUS[0]}
          else
              echo -n | openssl dgst -whirlpool -binary | xxd -p -c 256
              exit ${PIPESTATUS[0]}
          fi
      
      - name: _build_fallback_upgrade-ubcp-fetch
        shell: bash
        timeout-minutes: 120
        run: |
          ./ubiquitous_bash.sh _bin-build_import _build_fallback_upgrade-ubcp-fetch
      - name: _build_fallback_upgrade-ubcp-extract
        shell: bash
        timeout-minutes: 120
        run: |
          ./ubiquitous_bash.sh _bin-build_import _build_fallback_upgrade-ubcp-extract
      - name: _build_fallback_upgrade-ubcp-upgrade-ubiquitous_bash
        shell: bash
        timeout-minutes: 120
        run: |
          ./ubiquitous_bash.sh _bin-build_import _build_fallback_upgrade-ubcp-upgrade-ubiquitous_bash
      - name: _build_fallback_upgrade-ubcp-compress
        shell: bash
        timeout-minutes: 120
        run: |
          export skimfast=${{ inputs.skimfast }}
          echo $skimfast
          export devfast=${{ inputs.devfast }}
          echo $devfast
          ./ubiquitous_bash.sh _bin-build_import _build_fallback_upgrade-ubcp-compress

      - name: release!
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build_upgrade-${{ github.run_id }}-${{ github.run_attempt }}
          name: build_upgrade
          files: |
            package_ubcp-core.7z
            package_ubcp-core.log
            _local/upgradeTmp/ubcp-cygwin-portable-installer.log
            _custom_splice_opensslConfig.log
            _mitigate-ubcp.log
            _setupUbiquitous.log



  build_ubcp-report:
    runs-on: windows-latest
    steps:
      - name: _getCore_ubcp
        shell: pwsh
        timeout-minutes: 180
        run: |
          mkdir /core
          mkdir /core/infrastructure
          cd /core/infrastructure
 
          Invoke-WebRequest -Uri ((Invoke-RestMethod -Uri "https://api.github.com/repos/mirage335-colossus/ubiquitous_bash/releases/latest" -Headers @{Authorization = "Bearer ${{ secrets.GITHUB_TOKEN }}" }).assets | Where-Object {$_.name -eq "package_ubcp-core.7z"}).browser_download_url -OutFile ./package_ubcp-core.7z

          7z -y x ./package_ubcp-core.7z | tee /_getCore_ubcp.log
          rm ./package_ubcp-core.7z
      - name: _getMinimal_cloud
        shell: pwsh
        timeout-minutes: 180
        run: |
          $ErrorActionPreference="SilentlyContinue"
          $ErrorActionPreference = "Continue"
          #Set-MpPreference -DisableRealtimeMonitoring $true
          date > /wasHere.log
          pwd >> /wasHere.log
          cat /wasHere.log
          #choco install qalculate -y
          choco install dos2unix -y
          #choco install nmap -y
          git config --global core.autocrlf input
          git config --global core.eol lf
          choco install 7zip.install -y
          #choco install rclone -y
      - uses: actions/checkout@v3
      - name: statement! ls
        shell: pwsh
        run: |
          ls /
          ls
          Get-CimInstance -ClassName Win32_LogicalDisk | Select-Object -Property DeviceID,@{'Name' = 'FreeSpace (GB)'
          Expression= { [int]($_.FreeSpace / 1GB) }}
      - name: _setupUbiquitous
        shell: pwsh
        timeout-minutes: 240
        run: |
          .\_setupUbiquitous | tee /_setupUbiquitous.log
      - name: _test-lean
        shell: pwsh
        timeout-minutes: 240
        run: |
          Set-Item -Path Env:devfast -Value ("${{ inputs.devfast }}")
          ./_test | tee /_test-lean.log
          $SEL = cat /_test-lean.log | Select-String -Pattern 'FAIL' -CaseSensitive -SimpleMatch
          if ($SEL -ne $null)
          {
          cat /bin/false/pwsh
          }
          else
          {
          echo true | Out-Null
          }
      #- name: _test-lean-compressed
        #shell: pwsh
        #timeout-minutes: 240
        #run: |
          #Set-Item -Path Env:devfast -Value ("${{ inputs.devfast }}")
          #./_bin.bat ./lean_compressed.sh _test | tee /_test-lean-compressed.log
          #$SEL = cat /_test-lean-compressed.log | Select-String -Pattern 'FAIL' -CaseSensitive -SimpleMatch
          #if ($SEL -ne $null)
          #{
          #cat /bin/false/pwsh
          #}
          #else
          #{
          #echo true | Out-Null
          #}
      - name: _setupUbiquitous
        shell: pwsh
        timeout-minutes: 240
        run: |
          .\_setupUbiquitous | tee /_setupUbiquitous.log
      - name: _custom_splice_opensslConfig
        shell: pwsh
        timeout-minutes: 240
        run: |
          #./_bin _custom_splice_opensslConfig | tee /_custom_splice_opensslConfig.log
          ./_bin _bin /cygdrive/c/core/infrastructure/ubiquitous_bash/ubiquitous_bash.sh _custom_splice_opensslConfig | tee /_custom_splice_opensslConfig.log
      - name: _report_setup_ubcp
        shell: pwsh
        timeout-minutes: 240
        run: |
          ./_bin.bat ./ubiquitous_bash.sh _report_setup_ubcp | tee /_report_setup_ubcp.log
      - name: release!
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build_upgrade-${{ github.run_id }}-${{ github.run_attempt }}
          name: build_upgrade
          files: |
            /_test-lean.log
            /core/infrastructure/ubcp-binReport
            /core/infrastructure/ubcp-packageReport
      - name: statement! test-lean
        run: |
          cat /_test-lean.log
        shell: pwsh



  analysis_ubcp_missingBinaries:
    needs: [build_ubcp]
    runs-on: ubuntu-latest
    steps:
      - name: analysis! missing-binaries
        shell: bash
        run: |
          #echo -n
          _safeEcho() {
            printf '%s' "$1"
            shift
            
            [[ "$@" == "" ]] && return 0
            
            local currentArg
            for currentArg in "$@"
            do
              printf '%s' " "
              printf '%s' "$currentArg"
            done
            return 0
          }

          #echo
          _safeEcho_newline() {
            _safeEcho "$@"
            printf '\n'
          }
        
          # Get the list of releases
          RELEASES=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/mirage335-colossus/ubiquitous_bash/releases)
          
          # Download binReport file for the current release
          curl -s -H "Authorization: token $GH_TOKEN" -L -o "ubcp-binReport-$currentReleaseTag" "https://github.com/mirage335-colossus/ubiquitous_bash/releases/download/$currentReleaseTag/ubcp-binReport"

          # Loop through each release
          #for RELEASE in $(_safeEcho_newline "$RELEASES" | jq -r '.[].tag_name' | sort --reverse); do
          for RELEASE in $(_safeEcho_newline "$RELEASES" | jq -r 'sort_by(.published_at) | reverse | .[].tag_name' | tr -dc 'a-zA-Z0-9\-_.:\n'); do
            # Download the binReport file for this release
            curl -s -H "Authorization: token $GH_TOKEN" -L -o "ubcp-binReport-$RELEASE" "https://github.com/mirage335-colossus/ubiquitous_bash/releases/download/$RELEASE/ubcp-binReport"

            # Compare the list of binaries in this release to the current release
            if [ "$RELEASE" != "$currentReleaseTag" ]; then
              echo | tee -a ./missing-ubcp-binReport
              echo "Binaries (filesystem) in $RELEASE but not in currentRelease $currentReleaseTag:" | tee -a ./missing-ubcp-binReport
              comm -23 <(sort "ubcp-binReport-$RELEASE") <(sort "ubcp-binReport-$currentReleaseTag") | tee -a ./missing-ubcp-binReport
            fi
          done
        env:
          currentReleaseTag: build_upgrade-${{ github.run_id }}-${{ github.run_attempt }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: release! missing-ubcp-binReport
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build_upgrade-${{ github.run_id }}-${{ github.run_attempt }}
          name: build_upgrade
          files: |
            ./missing-ubcp-binReport


  analysis_ubcp_missingPackages:
    needs: [build_ubcp]
    runs-on: ubuntu-latest
    steps:
      - name: analysis! missing-packages
        shell: bash
        run: |
          #echo -n
          _safeEcho() {
            printf '%s' "$1"
            shift
            
            [[ "$@" == "" ]] && return 0
            
            local currentArg
            for currentArg in "$@"
            do
              printf '%s' " "
              printf '%s' "$currentArg"
            done
            return 0
          }

          #echo
          _safeEcho_newline() {
            _safeEcho "$@"
            printf '\n'
          }
        
          # Get the list of releases
          RELEASES=$(curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/repos/mirage335-colossus/ubiquitous_bash/releases?per_page=100&page=1)
          
          # Download packageReport file for the current release
          curl -s -H "Authorization: token $GH_TOKEN" -L -o "ubcp-packageReport-$currentReleaseTag" "https://github.com/mirage335-colossus/ubiquitous_bash/releases/download/$currentReleaseTag/ubcp-packageReport"

          # Loop through each release
          #for RELEASE in $(_safeEcho_newline "$RELEASES" | jq -r '.[].tag_name' | sort --reverse); do
          for RELEASE in $(_safeEcho_newline "$RELEASES" | jq -r 'sort_by(.published_at) | reverse | .[].tag_name' | tr -dc 'a-zA-Z0-9\-_.:\n'); do
            # Download the packageReport file for this release
            curl -s -H "Authorization: token $GH_TOKEN" -L -o "ubcp-packageReport-$RELEASE" "https://github.com/mirage335-colossus/ubiquitous_bash/releases/download/$RELEASE/ubcp-packageReport"

            # Compare the list of packages in this release to the current release
            if [ "$RELEASE" != "$currentReleaseTag" ]; then
              echo | tee -a ./missing-ubcp-packageReport
              echo "packages (filesystem) in $RELEASE but not in currentRelease $currentReleaseTag:" | tee -a ./missing-ubcp-packageReport
              comm -23 <(sort "ubcp-packageReport-$RELEASE") <(sort "ubcp-packageReport-$currentReleaseTag") | tee -a ./missing-ubcp-packageReport
            fi
          done
        env:
          currentReleaseTag: build_upgrade-${{ github.run_id }}-${{ github.run_attempt }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: release! missing-ubcp-packageReport
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build_upgrade-${{ github.run_id }}-${{ github.run_attempt }}
          name: build_upgrade
          files: |
            ./missing-ubcp-packageReport


















































































































  build_compressed:
    #needs: [build_guard]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: compile
        shell: bash
        timeout-minutes: 10
        run: |
          ./compile.sh
      - name: release! compile
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build_upgrade-${{ github.run_id }}-${{ github.run_attempt }}
          name: build_upgrade
          files: |
            ./lean_compressed.sh
            ./monolithic_compressed.sh
            ./rotten_compressed.sh
            ./ubcore_compressed.sh
            ./ubiquitous_bash_compressed.sh







